name: Deploy Branch Preview

on:
  push:
    branches-ignore: [main]

concurrency:
  group: deploy-branch-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check for open PR
        id: pr-check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr_count=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.ref_name }}" --state open --json number --jq 'length')
          if [ "$pr_count" -gt 0 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Skipping branch preview â€” open PR exists for this branch"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.pr-check.outputs.skip != 'true'

      - uses: pnpm/action-setup@v4
        if: steps.pr-check.outputs.skip != 'true'

      - uses: actions/setup-node@v4
        if: steps.pr-check.outputs.skip != 'true'
        with:
          node-version: 24
          cache: pnpm

      - run: pnpm install --frozen-lockfile
        if: steps.pr-check.outputs.skip != 'true'

      - run: pnpm run build
        if: steps.pr-check.outputs.skip != 'true'

      - name: Generate wrangler config
        if: steps.pr-check.outputs.skip != 'true'
        run: pnpm run wrangler:config
        env:
          DEPLOY_CONTEXT: branch-preview
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          BRANCH_NAME: ${{ github.ref_name }}

      - name: Deploy to Cloudflare Workers
        if: steps.pr-check.outputs.skip != 'true'
        run: pnpm exec wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Print preview URL
        if: steps.pr-check.outputs.skip != 'true'
        run: |
          SANITIZED=$(echo "${{ github.ref_name }}" | tr '[:upper:]' '[:lower:]' | sed 's/[/.]/-/g; s/[^a-z0-9-]//g; s/-\{2,\}/-/g; s/^-\+\|-\+$//g' | cut -c1-28)
          echo "### Branch Preview Deployed" >> "$GITHUB_STEP_SUMMARY"
          echo "https://${SANITIZED}-preview.bindpki.org" >> "$GITHUB_STEP_SUMMARY"
