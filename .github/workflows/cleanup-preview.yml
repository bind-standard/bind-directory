name: Cleanup Preview

on:
  workflow_dispatch:
    inputs:
      worker-name:
        description: Worker name to delete (e.g. bind-directory-pr-42)
        required: true
        type: string
  delete:

jobs:
  cleanup-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Delete worker
        run: npx wrangler delete --name "${{ inputs.worker-name }}" --force
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  cleanup-branch:
    if: github.event_name == 'delete' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Delete branch preview worker
        run: |
          SANITIZED=$(echo "${{ github.event.ref }}" | tr '[:upper:]' '[:lower:]' | sed 's/[/.]/-/g; s/[^a-z0-9-]//g; s/-\{2,\}/-/g; s/^-\+\|-\+$//g' | cut -c1-28)
          npx wrangler delete --name "bind-directory-${SANITIZED}" --force
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
